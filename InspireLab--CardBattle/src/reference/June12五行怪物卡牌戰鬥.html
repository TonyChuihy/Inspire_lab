<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>äº”è¡Œæ€ªç‰©å¡ç‰Œå°æˆ°éŠæˆ²</title>
    <style>
        body {
            font-family: 'Arial', sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            margin: 0;
            padding: 20px;
            min-height: 100vh;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            background: white;
            border-radius: 20px;
            padding: 30px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.1);
        }

        .title {
            text-align: center;
            color: #333;
            margin-bottom: 30px;
            font-size: 2.5em;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.1);
        }

        /* å¡ç‰Œç”Ÿæˆé é¢æ¨£å¼ */
        .card-creation-page {
            display: block;
        }

        .cards-section {
            display: flex;
            gap: 40px;
            margin-bottom: 30px;
        }

        .card-creator {
            flex: 1;
            background: #f8f9fa;
            padding: 25px;
            border-radius: 15px;
            border: 2px solid #e9ecef;
        }

        .card-preview {
            display: flex;
            justify-content: center;
            margin-bottom: 20px;
        }

        .pokemon-card {
            width: 280px;
            height: 400px;
            background: linear-gradient(135deg, #e5e7eb 0%, #d1d5db 100%);
            border-radius: 15px;
            border: 6px solid #fbbf24;
            position: relative;
            box-shadow: 0 10px 30px rgba(0,0,0,0.3);
            overflow: hidden;
        }

        .card-header {
            padding: 6px 12px 3px 12px;
            margin: 6px 8px 1px 8px;
            border-radius: 6px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            background: none;
            color: #000;
            transition: color 0.3s;
        }

        .card-header.dark-text {
            color: #fff;
        }

        .card-name {
            font-size: 14px;
            font-weight: bold;
            text-shadow: none;
        }

        .card-name.dark-text {
            text-shadow: 1px 1px 2px rgba(0,0,0,0.8);
        }

        .card-type {
            background: #374151;
            color: white;
            padding: 3px 8px;
            border-radius: 12px;
            font-size: 10px;
            font-weight: bold;
            text-transform: uppercase;
        }

        .energy-symbol {
            width: 16px;
            height: 16px;
            border-radius: 50%;
            display: inline-block;
            margin-left: 4px;
        }

        .card-image-container {
            width: 240px;
            height: 180px;
            background: #f3f4f6;
            margin: 1px auto 8px auto;
            border-radius: 8px;
            overflow: hidden;
            display: flex;
            align-items: center;
            justify-content: center;
            position: relative;
            border: 2px solid #6b7280;
        }

        .card-image {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .placeholder-text {
            color: #6b7280;
            text-align: center;
            font-size: 11px;
        }

        .card-stats {
            margin: 8px 12px 12px 12px;
            padding: 0;
            font-size: 11px;
            color: #000;
            transition: color 0.3s;
        }

        .card-stats.dark-text {
            color: #fff;
        }

        .stat-row {
            display: flex;
            justify-content: space-between;
            margin-bottom: 4px;
            background: none;
            padding: 0;
        }

        .skill-row {
            margin-bottom: 60px;
            line-height: 1.3;
            background: none;
            padding: 0;
        }

        .hp-display {
            font-size: 13px;
            font-weight: bold;
            text-shadow: none;
        }

        .hp-display.dark-text {
            text-shadow: 1px 1px 2px rgba(0,0,0,0.8);
        }

        .attack-display {
            font-size: 12px;
            font-weight: bold;
            text-shadow: none;
        }

        .attack-display.dark-text {
            text-shadow: 1px 1px 2px rgba(0,0,0,0.8);
        }

        .skill-display {
            font-size: 10px;
            text-shadow: none;
        }

        .skill-display.dark-text {
            text-shadow: 1px 1px 2px rgba(0,0,0,0.8);
        }

        .card-footer {
            position: absolute;
            bottom: 10px;
            left: 12px;
            right: 12px;
            background: none;
            padding: 0;
            border-radius: 0;
            font-size: 9px;
            color: #000;
            transition: color 0.3s;
        }

        .card-footer.dark-text {
            color: #fff;
        }

        .footer-row {
            margin-bottom: 6px;
            text-shadow: none;
            display: flex;
            justify-content: space-between;
        }

        .footer-row.dark-text {
            text-shadow: 1px 1px 2px rgba(0,0,0,0.8);
        }

        .weakness-resistance {
            font-weight: bold;
        }

        .bottom-stats {
            text-shadow: none;
            text-align: center;
        }

        .bottom-stats.dark-text {
            text-shadow: 1px 1px 2px rgba(0,0,0,0.8);
        }

        .form-group {
            margin-bottom: 15px;
        }

        .form-group label {
            display: block;
            margin-bottom: 6px;
            font-weight: bold;
            color: #374151;
            font-size: 14px;
        }

        .form-group input, .form-group textarea, .form-group select {
            width: 100%;
            padding: 8px;
            border: 2px solid #d1d5db;
            border-radius: 6px;
            font-size: 13px;
            transition: border-color 0.3s;
            box-sizing: border-box;
        }

        .form-group input:focus, .form-group textarea:focus, .form-group select:focus {
            outline: none;
            border-color: #10b981;
        }

        .form-group textarea {
            height: 60px;
            resize: vertical;
        }

        .file-input-wrapper {
            position: relative;
            display: inline-block;
            width: 100%;
        }

        .file-input {
            opacity: 0;
            position: absolute;
            width: 100%;
            height: 100%;
            cursor: pointer;
        }

        .file-input-label {
            display: block;
            padding: 8px;
            background: #10b981;
            color: white;
            text-align: center;
            border-radius: 6px;
            cursor: pointer;
            transition: background-color 0.3s;
            font-size: 13px;
        }

        .file-input-label:hover {
            background: #059669;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 12px;
        }

        .constraint-info {
            background: #fef3c7;
            border: 2px solid #f59e0b;
            padding: 12px;
            border-radius: 8px;
            margin-bottom: 15px;
            font-size: 12px;
            color: #92400e;
        }

        .constraint-info strong {
            color: #78350f;
        }

        .start-battle-btn {
            width: 100%;
            padding: 20px;
            background: linear-gradient(135deg, #dc2626, #b91c1c);
            color: white;
            border: none;
            border-radius: 15px;
            font-size: 24px;
            font-weight: bold;
            cursor: pointer;
            transition: transform 0.2s;
            margin-top: 30px;
            box-shadow: 0 8px 20px rgba(220, 38, 38, 0.3);
        }

        .start-battle-btn:hover {
            transform: translateY(-3px);
            box-shadow: 0 12px 30px rgba(220, 38, 38, 0.4);
        }

        .download-btn {
            width: 100%;
            padding: 12px;
            color: white;
            border: none;
            border-radius: 8px;
            font-size: 14px;
            font-weight: bold;
            cursor: pointer;
            margin-bottom: 10px;
            transition: transform 0.2s;
        }

        .download-btn:hover {
            transform: translateY(-2px);
        }

        /* æˆ°é¬¥é é¢æ¨£å¼ */
        .battle-page {
            display: none;
        }

        .battlefield {
            display: flex;
            justify-content: space-between;
            align-items: center;
            background: linear-gradient(135deg, #1e293b 0%, #334155 100%);
            padding: 30px;
            border-radius: 15px;
            color: white;
            position: relative;
            margin-bottom: 20px;
        }

        .battle-card {
            width: 280px;
            padding: 15px;
            background: linear-gradient(135deg, #e5e7eb 0%, #d1d5db 100%);
            border-radius: 15px;
            border: 6px solid #fbbf24;
            color: #000;
            text-align: center;
            position: relative;
            overflow: hidden;
        }

        .battle-image-container {
            width: 250px;
            height: 180px;
            background: #f3f4f6;
            margin: 10px auto;
            border-radius: 10px;
            overflow: hidden;
            display: flex;
            align-items: center;
            justify-content: center;
            border: 2px solid #6b7280;
        }

        .battle-image {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .monster-name {
            font-size: 18px;
            font-weight: bold;
            margin-bottom: 8px;
        }

        .monster-type {
            background: #374151;
            color: white;
            padding: 4px 8px;
            border-radius: 10px;
            font-size: 12px;
            margin-bottom: 8px;
            display: inline-block;
        }

        .hp-bar {
            width: 100%;
            height: 20px;
            background: #374151;
            border-radius: 10px;
            overflow: hidden;
            margin: 10px 0;
            position: relative;
        }

        .hp-fill {
            height: 100%;
            background: linear-gradient(90deg, #22c55e 0%, #16a34a 50%, #dc2626 100%);
            transition: width 0.5s ease;
            border-radius: 10px;
        }

        .hp-text {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            font-size: 12px;
            font-weight: bold;
            color: white;
            text-shadow: 1px 1px 2px rgba(0,0,0,0.8);
        }

        .monster-stats {
            font-size: 14px;
            margin: 4px 0;
        }

        .vs-text {
            font-size: 48px;
            font-weight: bold;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.5);
            animation: pulse 2s infinite;
        }

        @keyframes pulse {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.1); }
        }

        .action-panel {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 15px;
            border: 2px solid #e9ecef;
        }

        .action-buttons {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 15px;
            margin-bottom: 20px;
        }

        .action-btn {
            padding: 15px;
            font-size: 16px;
            font-weight: bold;
            border: none;
            border-radius: 10px;
            cursor: pointer;
            transition: all 0.3s;
        }

        .attack-btn {
            background: linear-gradient(135deg, #dc2626, #b91c1c);
            color: white;
        }

        .skill-btn {
            background: linear-gradient(135deg, #7c3aed, #6d28d9);
            color: white;
        }

        .defend-btn {
            background: linear-gradient(135deg, #059669, #047857);
            color: white;
        }

        .action-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0,0,0,0.2);
        }

        .action-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none;
        }

        .battle-log {
            height: 200px;
            overflow-y: auto;
            background: #1e293b;
            color: #e2e8f0;
            padding: 15px;
            border-radius: 10px;
            font-family: 'Courier New', monospace;
            font-size: 14px;
            line-height: 1.6;
            display: block;
        }

        .log-entry {
            margin-bottom: 8px;
            padding: 5px 10px;
            border-radius: 5px;
        }

        .log-attack { background: rgba(220, 38, 38, 0.2); }
        .log-skill { background: rgba(124, 58, 237, 0.2); }
        .log-defend { background: rgba(5, 150, 105, 0.2); }
        .log-system { background: rgba(59, 130, 246, 0.2); }

        .game-over {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.8);
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 1000;
        }

        .game-over-content {
            background: white;
            padding: 40px;
            border-radius: 20px;
            text-align: center;
            max-width: 400px;
            width: 90%;
        }

        .winner-text {
            font-size: 2em;
            margin-bottom: 20px;
            color: #10b981;
        }

        .restart-btn {
            padding: 15px 30px;
            background: linear-gradient(135deg, #3b82f6, #2563eb);
            color: white;
            border: none;
            border-radius: 10px;
            font-size: 16px;
            cursor: pointer;
            margin-right: 10px;
        }

        .back-btn {
            padding: 15px 30px;
            background: linear-gradient(135deg, #6b7280, #4b5563);
            color: white;
            border: none;
            border-radius: 10px;
            font-size: 16px;
            cursor: pointer;
        }

        /* äº”è¡Œé¡è‰²æ¨£å¼ */
        .wuxing-jin {
            background: linear-gradient(135deg, #fbbf24 0%, #f59e0b 100%);
        }

        .wuxing-mu {
            background: linear-gradient(135deg, #4ade80 0%, #22c55e 100%);
        }

        .wuxing-shui {
            background: linear-gradient(135deg, #60a5fa 0%, #2563eb 100%);
        }

        .wuxing-huo {
            background: linear-gradient(135deg, #f87171 0%, #dc2626 100%);
        }

        .wuxing-tu {
            background: linear-gradient(135deg, #d2691e 0%, #8b4513 100%);
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- å¡ç‰Œç”Ÿæˆé é¢ -->
        <div class="card-creation-page" id="cardCreationPage">
            <h1 class="title">ğŸ¥‡ ğŸŒ³ äº”è¡Œæ€ªç‰©å¡ç‰Œæˆ°é¬¥ ğŸŒŠğŸ”¥â›°ï¸</h1>
            
            <div class="cards-section">
                <!-- å·¦å´å¡ç‰Œ -->
                <div class="card-creator">
                    <h3 style="text-align: center; color: #dc2626;">ç©å®¶ä¸€è™Ÿ</h3>
                    
                    <div class="card-preview">
                        <div class="pokemon-card" id="player1Card">
                            <div class="card-header" id="player1Header">
                                <span id="player1Name" class="card-name">æ°´æ™¶ç¸</span>
                                <div>
                                    <span class="card-type" id="player1Type">åœŸ</span>
                                    <span class="energy-symbol" id="player1Energy"></span>
                                </div>
                            </div>
                            
                            <div class="card-image-container" id="player1ImageContainer">
                                <div class="placeholder-text">è«‹é¸æ“‡æ€ªç‰©åœ–ç‰‡</div>
                            </div>
                            
                            <div class="card-stats" id="player1Stats">
                                <div class="stat-row">
                                    <strong>HP:</strong> <span id="player1Hp" class="hp-display">50</span>
                                </div>
                                <div class="stat-row">
                                    <strong>æ”»æ“Š:</strong> <span id="player1Attack" class="attack-display">50</span>
                                </div>
                                <div class="skill-row">
                                    <strong>æŠ€èƒ½ä¸€:</strong> <span id="player1Skill1" class="skill-display">åœŸçŸ³çˆ†è£‚ï¼šé€ æˆ11é»å‚·å®³</span>
                                </div>
                                <div class="skill-row">
                                    <strong>æŠ€èƒ½äºŒ:</strong> <span id="player1Skill2" class="skill-display">å¤§åœ°å®ˆè­·ï¼šç²å¾—è­·ç›¾æ•ˆæœ</span>
                                </div>
                            </div>
                            
                            <div class="card-footer" id="player1Footer">
                                <div class="footer-row" id="player1FooterRow">
                                    <span class="weakness-resistance">å¼±é»: <span id="player1Weakness">æœ¨ +20</span></span>
                                    <span class="weakness-resistance">æŠ—æ€§: <span id="player1Resistance">æ°´ -10</span></span>
                                </div>
                                <div class="bottom-stats" id="player1BottomStats">
                                    æ’¤é€€æ¶ˆè€—: <span id="player1Retreat">2</span> | é˜²ç¦¦: <span id="player1Defense">25</span>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="constraint-info">
                        <strong>å±¬æ€§ç›¸å‰‹ç³»çµ±ï¼š</strong><br>
                        â€¢ <strong>å¼±é»</strong>ï¼š"æœ¨ +20" â†’ æœ¨å±¬æ€§æ”»æ“ŠåœŸæ™‚å‚·å®³ Ã—1.2<br>
                        â€¢ <strong>æŠ—æ€§</strong>ï¼š"æ°´ -10" â†’ æ°´å±¬æ€§æ”»æ“Šæ™‚å‚·å®³ Ã—0.9<br>
                        <br>
                        <strong>æ¨è–¦çš„æŠ€èƒ½ç¯„ä¾‹ï¼š</strong><br>
                        â€¢ "ç«çƒè¡“ï¼šé€ æˆ9é»å‚·å®³"<br>
                        â€¢ "å†°éŒï¼šé€ æˆ11é»å‚·å®³"<br>
                        â€¢ "æ²»ç™‚è¡“ï¼šæ¢å¾©8é»ç”Ÿå‘½å€¼"<br>
                        â€¢ "éµå£ï¼šç²å¾—è­·ç›¾æ•ˆæœ"<br>
                        â€¢ "ç‹‚åŒ–ï¼šå¢åŠ 12é»æ”»æ“ŠåŠ›"
                    </div>

                    <div class="form-group">
                        <label for="player1Image">é¸æ“‡æ€ªç‰©åœ–ç‰‡ï¼š</label>
                        <div class="file-input-wrapper">
                            <input type="file" id="player1Image" class="file-input" accept="image/*">
                            <label for="player1Image" class="file-input-label">é»æ“Šé¸æ“‡åœ–ç‰‡</label>
                        </div>
                    </div>

                    <div class="form-group">
                        <label for="player1NameInput">æ€ªç‰©åç¨±ï¼š</label>
                        <input type="text" id="player1NameInput" placeholder="è¼¸å…¥æ€ªç‰©åç¨±" value="æ°´æ™¶ç¸">
                    </div>

                    <div class="form-group">
                        <label for="player1TypeInput">äº”è¡Œå±¬æ€§ï¼š</label>
                        <select id="player1TypeInput">
                            <option value="é‡‘">é‡‘ (é‡‘å±¬)</option>
                            <option value="æœ¨">æœ¨ (æ¤ç‰©)</option>
                            <option value="æ°´">æ°´ (æµæ°´)</option>
                            <option value="ç«">ç« (çƒˆç„°)</option>
                            <option value="åœŸ" selected>åœŸ (å¤§åœ°)</option>
                        </select>
                    </div>

                    <div class="stats-grid">
                        <div class="form-group">
                            <label for="player1HpInput">HP (ç”Ÿå‘½å€¼)ï¼š</label>
                            <input type="number" id="player1HpInput" value="50" min="10" max="90">
                            <small>ç¯„åœï¼š10-90</small>
                        </div>
                        <div class="form-group">
                            <label for="player1AttackInput">æ”»æ“ŠåŠ›ï¼š</label>
                            <input type="number" id="player1AttackInput" value="50" min="10" max="90">
                            <small>ç¯„åœï¼š10-90</small>
                        </div>
                    </div>

                    <div class="stats-grid">
                        <div class="form-group">
                            <label for="player1DefenseInput">é˜²ç¦¦åŠ›ï¼š</label>
                            <input type="number" id="player1DefenseInput" value="25" min="0" max="100" readonly>
                            <small>è‡ªå‹•è¨ˆç®— (HPÃ—æ”»æ“ŠÃ·100)</small>
                        </div>
                        <div class="form-group">
                            <label for="player1RetreatInput">æ’¤é€€æ¶ˆè€—ï¼š</label>
                            <input type="number" id="player1RetreatInput" value="2" min="0" max="5">
                        </div>
                    </div>

                    <div class="form-group">
                        <label for="player1WeaknessInput">å¼±é»ï¼š</label>
                        <input type="text" id="player1WeaknessInput" placeholder="ä¾‹ï¼šç« +20" value="æœ¨ +20" readonly>
                    </div>

                    <div class="form-group">
                        <label for="player1ResistanceInput">æŠ—æ€§ï¼š</label>
                        <input type="text" id="player1ResistanceInput" placeholder="ä¾‹ï¼šæ°´ -10" value="åœŸ -10" readonly>
                    </div>

                    <div class="form-group">
                        <label for="player1Skill1Input">æŠ€èƒ½ä¸€ï¼š</label>
                        <textarea id="player1Skill1Input" placeholder="æè¿°æ€ªç‰©çš„ç¬¬ä¸€å€‹æŠ€èƒ½...">åœŸçŸ³çˆ†è£‚ï¼šé€ æˆ11é»å‚·å®³ã€‚</textarea>
                    </div>

                    <div class="form-group">
                        <label for="player1Skill2Input">æŠ€èƒ½äºŒï¼š</label>
                        <textarea id="player1Skill2Input" placeholder="æè¿°æ€ªç‰©çš„ç¬¬äºŒå€‹æŠ€èƒ½...">å¤§åœ°å®ˆè­·ï¼šç²å¾—è­·ç›¾æ•ˆæœã€‚</textarea>
                    </div>

                    <button class="download-btn" onclick="downloadCard('player1')" style="background: linear-gradient(135deg, #3b82f6, #2563eb);">ğŸ“¥ ä¸‹è¼‰å·¦å´å¡ç‰Œ</button>
                </div>

                <!-- å³å´å¡ç‰Œ -->
                <div class="card-creator">
                    <h3 style="text-align: center; color: #2563eb;">ç©å®¶äºŒè™Ÿ</h3>
                    
                    <div class="card-preview">
                        <div class="pokemon-card" id="player2Card">
                            <div class="card-header" id="player2Header">
                                <span id="player2Name" class="card-name">é»ƒéµç¤¦ç¸</span>
                                <div>
                                    <span class="card-type" id="player2Type">é‡‘</span>
                                    <span class="energy-symbol" id="player2Energy"></span>
                                </div>
                            </div>
                            
                            <div class="card-image-container" id="player2ImageContainer">
                                <div class="placeholder-text">è«‹é¸æ“‡æ€ªç‰©åœ–ç‰‡</div>
                            </div>
                            
                            <div class="card-stats" id="player2Stats">
                                <div class="stat-row">
                                    <strong>HP:</strong> <span id="player2Hp" class="hp-display">60</span>
                                </div>
                                <div class="stat-row">
                                    <strong>æ”»æ“Š:</strong> <span id="player2Attack" class="attack-display">40</span>
                                </div>
                                <div class="skill-row">
                                    <strong>æŠ€èƒ½ä¸€:</strong> <span id="player2Skill1" class="skill-display">ç‹‚åŒ–ï¼šå¢åŠ 12é»æ”»æ“ŠåŠ›</span>
                                </div>
                                <div class="skill-row">
                                    <strong>æŠ€èƒ½äºŒ:</strong> <span id="player2Skill2" class="skill-display">é‡‘çŸ³ç‚ºé–‹ï¼šæ¢å¾©8é»ç”Ÿå‘½å€¼</span>
                                </div>
                            </div>
                            
                            <div class="card-footer" id="player2Footer">
                                <div class="footer-row" id="player2FooterRow">
                                    <span class="weakness-resistance">å¼±é»: <span id="player2Weakness">ç« +20</span></span>
                                    <span class="weakness-resistance">æŠ—æ€§: <span id="player2Resistance">æœ¨ -10</span></span>
                                </div>
                                <div class="bottom-stats" id="player2BottomStats">
                                    æ’¤é€€æ¶ˆè€—: <span id="player2Retreat">1</span> | é˜²ç¦¦: <span id="player2Defense">24</span>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="constraint-info">
                        <strong>éŠæˆ²è¦å‰‡ï¼š</strong><br>
                        â€¢ HP + æ”»æ“ŠåŠ› = 100<br>
                        â€¢ é˜²ç¦¦åŠ› = HP Ã— æ”»æ“ŠåŠ› Ã· 100<br>
                        â€¢ äº”è¡Œç›¸å‰‹ï¼šé‡‘å…‹æœ¨ï¼Œæœ¨å…‹åœŸï¼ŒåœŸå…‹æ°´ï¼Œæ°´å…‹ç«ï¼Œç«å…‹é‡‘<br>
                        <br>
                        <strong>å‚·å®³è¨ˆç®—ï¼š</strong><br>
                        â€¢ æ™®é€šæ”»æ“Š = (æ”»æ“ŠåŠ›Ã·é˜²ç¦¦åŠ›Ã—2)+3<br>
                        â€¢ æŠ€èƒ½æ”»æ“Š = æŠ€èƒ½æ•¸å€¼-é˜²ç¦¦åŠ›Ã·10<br>
                        â€¢ æœ€çµ‚å‚·å®³ = åŸºç¤å‚·å®³Ã—å±¬æ€§å…‹åˆ¶Ã—éš¨æ©Ÿæ³¢å‹•(Â±20%)Ã—é˜²ç¦¦ç‹€æ…‹<br>
                        â€¢ é˜²ç¦¦ç‹€æ…‹ï¼šæ¸›å°‘30%å‚·å®³ / è­·ç›¾æ•ˆæœï¼šæ¸›å°‘50%å‚·å®³
                    </div>

                    <div class="form-group">
                        <label for="player2Image">é¸æ“‡æ€ªç‰©åœ–ç‰‡ï¼š</label>
                        <div class="file-input-wrapper">
                            <input type="file" id="player2Image" class="file-input" accept="image/*">
                            <label for="player2Image" class="file-input-label">é»æ“Šé¸æ“‡åœ–ç‰‡</label>
                        </div>
                    </div>

                    <div class="form-group">
                        <label for="player2NameInput">æ€ªç‰©åç¨±ï¼š</label>
                        <input type="text" id="player2NameInput" placeholder="è¼¸å…¥æ€ªç‰©åç¨±" value="é»ƒéµç¤¦ç¸">
                    </div>

                    <div class="form-group">
                        <label for="player2TypeInput">äº”è¡Œå±¬æ€§ï¼š</label>
                        <select id="player2TypeInput">
                            <option value="é‡‘" selected>é‡‘ (é‡‘å±¬)</option>
                            <option value="æœ¨">æœ¨ (æ¤ç‰©)</option>
                            <option value="æ°´">æ°´ (æµæ°´)</option>
                            <option value="ç«">ç« (çƒˆç„°)</option>
                            <option value="åœŸ">åœŸ (å¤§åœ°)</option>
                        </select>
                    </div>

                    <div class="stats-grid">
                        <div class="form-group">
                            <label for="player2HpInput">HP (ç”Ÿå‘½å€¼)ï¼š</label>
                            <input type="number" id="player2HpInput" value="60" min="10" max="90">
                            <small>ç¯„åœï¼š10-90</small>
                        </div>
                        <div class="form-group">
                            <label for="player2AttackInput">æ”»æ“ŠåŠ›ï¼š</label>
                            <input type="number" id="player2AttackInput" value="40" min="10" max="90">
                            <small>ç¯„åœï¼š10-90</small>
                        </div>
                    </div>

                    <div class="stats-grid">
                        <div class="form-group">
                            <label for="player2DefenseInput">é˜²ç¦¦åŠ›ï¼š</label>
                            <input type="number" id="player2DefenseInput" value="24" min="0" max="100" readonly>
                            <small>è‡ªå‹•è¨ˆç®— (HPÃ—æ”»æ“ŠÃ·100)</small>
                        </div>
                        <div class="form-group">
                            <label for="player2RetreatInput">æ’¤é€€æ¶ˆè€—ï¼š</label>
                            <input type="number" id="player2RetreatInput" value="1" min="0" max="5">
                        </div>
                    </div>

                    <div class="form-group">
                        <label for="player2WeaknessInput">å¼±é»ï¼š</label>
                        <input type="text" id="player2WeaknessInput" placeholder="ä¾‹ï¼šç« +20" value="åœŸ +20" readonly>
                    </div>

                    <div class="form-group">
                        <label for="player2ResistanceInput">æŠ—æ€§ï¼š</label>
                        <input type="text" id="player2ResistanceInput" placeholder="ä¾‹ï¼šæ°´ -10" value="ç« -10" readonly>
                    </div>

                    <div class="form-group">
                        <label for="player2Skill1Input">æŠ€èƒ½ä¸€ï¼š</label>
                        <textarea id="player2Skill1Input" placeholder="æè¿°æ€ªç‰©çš„ç¬¬ä¸€å€‹æŠ€èƒ½...">ç‹‚åŒ–ï¼šå¢åŠ 12é»æ”»æ“ŠåŠ›ã€‚</textarea>
                    </div>

                    <div class="form-group">
                        <label for="player2Skill2Input">æŠ€èƒ½äºŒï¼š</label>
                        <textarea id="player2Skill2Input" placeholder="æè¿°æ€ªç‰©çš„ç¬¬äºŒå€‹æŠ€èƒ½...">é‡‘çŸ³ç‚ºé–‹ï¼šæ¢å¾©8é»ç”Ÿå‘½å€¼ã€‚</textarea>
                    </div>

                    <button class="download-btn" onclick="downloadCard('player2')" style="background: linear-gradient(135deg, #f59e0b, #d97706);">ğŸ“¥ ä¸‹è¼‰å³å´å¡ç‰Œ</button>
                </div>
            </div>

            <button class="start-battle-btn" onclick="startBattle()">âš”ï¸ é–‹å§‹æ±ºé¬¥</button>
        </div>

        <!-- æˆ°é¬¥é é¢ -->
        <div class="battle-page" id="battlePage">
            <h1 class="title">âš”ï¸ äº”è¡Œæ€ªç‰©å°æˆ°</h1>
            
            <div class="battlefield">
                <div class="battle-card" id="battlePlayer1Card">
                    <div class="monster-name" id="battlePlayer1Name">æ°´æ™¶ç¸</div>
                    <div class="monster-type" id="battlePlayer1Type">åœŸ</div>
                    <div class="battle-image-container" id="battlePlayer1ImageContainer">
                        <div class="placeholder-text">ç­‰å¾…åœ–ç‰‡è¼‰å…¥...</div>
                    </div>
                    <div class="hp-bar">
                        <div class="hp-fill" id="battlePlayer1HpFill"></div>
                        <div class="hp-text" id="battlePlayer1HpText">50/50</div>
                    </div>
                    <div class="monster-stats">
                        æ”»æ“Š: <span id="battlePlayer1Attack">50</span>
                    </div>
                    <div class="monster-stats">
                        é˜²ç¦¦: <span id="battlePlayer1Defense">25</span>
                    </div>
                </div>

                <div class="vs-text">VS</div>

                <div class="battle-card" id="battlePlayer2Card">
                    <div class="monster-name" id="battlePlayer2Name">é»ƒéµç¤¦ç¸</div>
                    <div class="monster-type" id="battlePlayer2Type">é‡‘</div>
                    <div class="battle-image-container" id="battlePlayer2ImageContainer">
                        <div class="placeholder-text">ç­‰å¾…åœ–ç‰‡è¼‰å…¥...</div>
                    </div>
                    <div class="hp-bar">
                        <div class="hp-fill" id="battlePlayer2HpFill"></div>
                        <div class="hp-text" id="battlePlayer2HpText">60/60</div>
                    </div>
                    <div class="monster-stats">
                        æ”»æ“Š: <span id="battlePlayer2Attack">40</span>
                    </div>
                    <div class="monster-stats">
                        é˜²ç¦¦: <span id="battlePlayer2Defense">24</span>
                    </div>
                </div>
            </div>

            <div class="action-panel">
                <h3>âš”ï¸ å…¨è‡ªå‹•æˆ°é¬¥æ¨¡å¼</h3>
                <p style="text-align: center; margin-bottom: 20px; color: #6b7280;">é»æ“Šéª°å­é€²è¡Œä¸€å€‹å›åˆçš„æˆ°é¬¥ï¼</p>
                <div style="display: flex; justify-content: center; margin-bottom: 20px;">
                    <button class="action-btn" onclick="nextTurn()" id="diceBtn" style="background: linear-gradient(135deg, #8b5cf6, #7c3aed); color: white; font-size: 18px; padding: 15px 30px; border-radius: 15px;">
                        ğŸ² æ“²éª°å­ (ç­‰å¾…é–‹å§‹)
                    </button>
                </div>
                
                <div id="battleLogSection">
                    <h3>æˆ°é¬¥è¨˜éŒ„ï¼š</h3>
                    <div class="battle-log" id="battleLog"></div>
                </div>
            </div>
        </div>
    </div>

    <div class="game-over" id="gameOver">
        <div class="game-over-content">
            <div class="winner-text" id="winnerText">ğŸ‰ å‹åˆ©ï¼</div>
            <p id="gameOverMessage">æ­å–œä½ è´å¾—äº†é€™å ´å²è©©èˆ¬çš„æˆ°é¬¥ï¼</p>
            <button class="restart-btn" onclick="restartBattle()">ğŸ”„ é‡æ–°æˆ°é¬¥</button>
            <button class="back-btn" onclick="backToCreation()">ğŸ  è¿”å›å‰µå»º</button>
        </div>
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <script>
        let gameState = {
            player1: {},
            player2: {},
            currentTurn: 'player1',
            battleEnded: false,
            skillCooldown: 0,
            player1Image: null,
            player2Image: null
        };

        // äº”è¡Œç›¸å‰‹é—œä¿‚
        const wuxingRelations = {
            'é‡‘': { weakness: 'ç«', resistance: 'æœ¨' },
            'æœ¨': { weakness: 'é‡‘', resistance: 'åœŸ' },
            'æ°´': { weakness: 'åœŸ', resistance: 'ç«' },
            'ç«': { weakness: 'æ°´', resistance: 'é‡‘' },
            'åœŸ': { weakness: 'æœ¨', resistance: 'æ°´' }
        };

        // äº”è¡Œå°æ‡‰é¡è‰²
        const wuxingColors = {
            'é‡‘': {
                background: 'linear-gradient(135deg, #fbbf24 0%, #f59e0b 100%)',
                energy: '#f59e0b',
                isDark: false
            },
            'æœ¨': {
                background: 'linear-gradient(135deg, #4ade80 0%, #22c55e 100%)',
                energy: '#22c55e',
                isDark: false
            },
            'æ°´': {
                background: 'linear-gradient(135deg, #60a5fa 0%, #2563eb 100%)',
                energy: '#2563eb',
                isDark: false
            },
            'ç«': {
                background: 'linear-gradient(135deg, #f87171 0%, #dc2626 100%)',
                energy: '#dc2626',
                isDark: false
            },
            'åœŸ': {
                background: 'linear-gradient(135deg, #d2691e 0%, #8b4513 100%)',
                energy: '#8b4513',
                isDark: false
            }
        };

        // åœ–ç‰‡ä¸Šå‚³è™•ç†
        document.getElementById('player1Image').addEventListener('change', function(e) {
            const file = e.target.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = function(e) {
                    gameState.player1Image = e.target.result;
                    updateCardImage('player1', e.target.result);
                };
                reader.readAsDataURL(file);
            }
        });

        document.getElementById('player2Image').addEventListener('change', function(e) {
            const file = e.target.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = function(e) {
                    gameState.player2Image = e.target.result;
                    updateCardImage('player2', e.target.result);
                };
                reader.readAsDataURL(file);
            }
        });

        function updateCardImage(player, imageSrc) {
            const container = document.getElementById(`${player}ImageContainer`);
            container.innerHTML = `<img src="${imageSrc}" alt="æ€ªç‰©åœ–ç‰‡" class="card-image">`;
        }

        function updateBattleImage(player, imageSrc) {
            const container = document.getElementById(`battle${player.charAt(0).toUpperCase() + player.slice(1)}ImageContainer`);
            if (imageSrc) {
                container.innerHTML = `<img src="${imageSrc}" alt="æ€ªç‰©åœ–ç‰‡" class="battle-image">`;
            } else {
                container.innerHTML = '<div class="placeholder-text">æ²’æœ‰åœ–ç‰‡</div>';
            }
        }

        function updateHPAttackConstraint(player) {
            const hpInput = document.getElementById(`${player}HpInput`);
            const attackInput = document.getElementById(`${player}AttackInput`);
            const hp = parseInt(hpInput.value) || 0;
            const attack = parseInt(attackInput.value) || 0;
            
            // HP + æ”»æ“ŠåŠ› = 100ï¼Œæª¢æŸ¥å“ªå€‹è¢«ä¿®æ”¹
            const total = hp + attack;
            if (total !== 100) {
                // æ ¹æ“šæœ€å¾Œä¿®æ”¹çš„è¼¸å…¥æ¡†èª¿æ•´å¦ä¸€å€‹
                if (document.activeElement === hpInput) {
                    attackInput.value = 100 - hp;
                } else if (document.activeElement === attackInput) {
                    hpInput.value = 100 - attack;
                }
            }
            
            // æ›´æ–°é¡¯ç¤º
            document.getElementById(`${player}Hp`).textContent = hpInput.value;
            document.getElementById(`${player}Attack`).textContent = attackInput.value;
            
            // æ›´æ–°é˜²ç¦¦åŠ›
            updateDefenseFromHPAttack(player);
        }

        function updateDefenseFromHPAttack(player) {
            const hp = parseInt(document.getElementById(`${player}HpInput`).value) || 0;
            const attack = parseInt(document.getElementById(`${player}AttackInput`).value) || 0;
            const defenseInput = document.getElementById(`${player}DefenseInput`);
            
            // é˜²ç¦¦åŠ› = HP Ã— æ”»æ“ŠåŠ› Ã· 100
            const defense = Math.floor((hp * attack) / 100);
            defenseInput.value = defense;
            document.getElementById(`${player}Defense`).textContent = defense;
        }

        function updateTypeDefaults(player, type) {
            const relations = wuxingRelations[type];
            if (relations) {
                const weaknessText = `${relations.weakness} +20`;
                const resistanceText = `${relations.resistance} -10`;
                
                document.getElementById(`${player}WeaknessInput`).value = weaknessText;
                document.getElementById(`${player}ResistanceInput`).value = resistanceText;
                document.getElementById(`${player}Weakness`).textContent = weaknessText;
                document.getElementById(`${player}Resistance`).textContent = resistanceText;
            }
        }

        function updateCardColors(player) {
            const cardElement = document.getElementById(`${player}Card`);
            const energySymbol = document.getElementById(`${player}Energy`);
            const type = document.getElementById(`${player}TypeInput`).value;
            
            // ç²å–æ‰€æœ‰éœ€è¦æ”¹è®Šé¡è‰²çš„å…ƒç´ 
            const cardHeader = document.getElementById(`${player}Header`);
            const cardName = document.getElementById(`${player}Name`);
            const cardStats = document.getElementById(`${player}Stats`);
            const cardFooter = document.getElementById(`${player}Footer`);
            const footerRow = document.getElementById(`${player}FooterRow`);
            const bottomStats = document.getElementById(`${player}BottomStats`);
            
            const colors = wuxingColors[type];
            if (colors) {
                cardElement.style.background = colors.background;
                energySymbol.style.background = colors.energy;
                
                // æ”¶é›†æ‰€æœ‰æ–‡å­—å…ƒç´ 
                const textElements = [
                    cardHeader, cardName, cardStats, cardFooter, footerRow, bottomStats
                ];
                
                // æ‰€æœ‰å±¬æ€§éƒ½ä½¿ç”¨é»‘è‰²æ–‡å­—
                textElements.forEach(element => {
                    if (element) {
                        element.classList.remove('dark-text');
                    }
                });
            }
        }

        // å³æ™‚æ›´æ–°å¡ç‰Œå…§å®¹
        function setupRealTimeUpdates() {
            // ç‚ºå…©å€‹ç©å®¶è¨­ç½®æ›´æ–°
            ['player1', 'player2'].forEach(player => {
                // HPå’Œæ”»æ“ŠåŠ›è®Šæ›´æ™‚äº’ç›¸èª¿æ•´
                document.getElementById(`${player}HpInput`).addEventListener('input', function() {
                    updateHPAttackConstraint(player);
                });

                document.getElementById(`${player}AttackInput`).addEventListener('input', function() {
                    updateHPAttackConstraint(player);
                });

                // å…¶ä»–è¼¸å…¥æ¡†çš„å³æ™‚æ›´æ–°
                const inputs = [
                    { id: `${player}NameInput`, target: `${player}Name` },
                    { id: `${player}TypeInput`, target: `${player}Type` },
                    { id: `${player}RetreatInput`, target: `${player}Retreat` },
                    { id: `${player}Skill1Input`, target: `${player}Skill1` },
                    { id: `${player}Skill2Input`, target: `${player}Skill2` }
                ];

                inputs.forEach(input => {
                    document.getElementById(input.id).addEventListener('input', function() {
                        document.getElementById(input.target).textContent = this.value;
                        
                        // å¦‚æœæ˜¯å±¬æ€§é¡å‹è®Šæ›´ï¼Œä¹Ÿè¦æ›´æ–°é¡è‰²å’Œé è¨­å€¼
                        if (input.id === `${player}TypeInput`) {
                            updateCardColors(player);
                            updateTypeDefaults(player, this.value);
                        }
                    });
                });
            });
        }

        // æˆ°é¬¥ç³»çµ±
        function startBattle() {
            // åˆå§‹åŒ–ç©å®¶æ•¸æ“šï¼ŒåŒ…å«æŠ€èƒ½æè¿°
            gameState.player1 = {
                name: document.getElementById('player1NameInput').value,
                type: document.getElementById('player1TypeInput').value,
                maxHp: parseInt(document.getElementById('player1HpInput').value),
                currentHp: parseInt(document.getElementById('player1HpInput').value),
                attack: parseInt(document.getElementById('player1AttackInput').value),
                defense: parseInt(document.getElementById('player1DefenseInput').value),
                skill1: document.getElementById('player1Skill1Input').value,
                skill2: document.getElementById('player1Skill2Input').value,
                isDefending: false
            };

            gameState.player2 = {
                name: document.getElementById('player2NameInput').value,
                type: document.getElementById('player2TypeInput').value,
                maxHp: parseInt(document.getElementById('player2HpInput').value),
                currentHp: parseInt(document.getElementById('player2HpInput').value),
                attack: parseInt(document.getElementById('player2AttackInput').value),
                defense: parseInt(document.getElementById('player2DefenseInput').value),
                skill1: document.getElementById('player2Skill1Input').value,
                skill2: document.getElementById('player2Skill2Input').value,
                isDefending: false
            };

            // éš¨æ©Ÿæ±ºå®šå…ˆæ‰‹
            gameState.currentTurn = Math.random() < 0.5 ? 'player1' : 'player2';
            gameState.battleEnded = false;
            gameState.skillCooldown = 0;

            // æ›´æ–°UI
            updateBattleUI();
            updateBattleImage('player1', gameState.player1Image);
            updateBattleImage('player2', gameState.player2Image);
            document.getElementById('cardCreationPage').style.display = 'none';
            document.getElementById('battlePage').style.display = 'block';
            
            addBattleLog('ğŸ® æˆ°é¬¥é–‹å§‹ï¼', 'system');
            addBattleLog(`${gameState.player1.name} VS ${gameState.player2.name}`, 'system');
            addBattleLog(`ğŸ¯ ${gameState[gameState.currentTurn].name} ç²å¾—å…ˆæ‰‹æ¬Šï¼`, 'system');
        }

        function updateBattleUI() {
            // æ›´æ–°ç©å®¶1å¡ç‰Œ
            if (gameState.player1 && gameState.player1.name) {
                document.getElementById('battlePlayer1Name').textContent = gameState.player1.name;
                document.getElementById('battlePlayer1Type').textContent = gameState.player1.type.toUpperCase();
                // é¡¯ç¤ºç•¶å‰æ”»æ“ŠåŠ›ï¼ˆåŒ…å«åŠ æˆï¼‰
                const currentAttack = gameState.player1.attack + (gameState.player1.tempAttackBoost || 0);
                document.getElementById('battlePlayer1Attack').textContent = currentAttack;
                // é¡¯ç¤ºç•¶å‰é˜²ç¦¦åŠ›ï¼ˆåŒ…å«åŠ æˆï¼‰
                const currentDefense = gameState.player1.defense + (gameState.player1.tempDefenseBoost || 0);
                document.getElementById('battlePlayer1Defense').textContent = currentDefense;
                document.getElementById('battlePlayer1Card').className = `battle-card wuxing-${getWuxingClass(gameState.player1.type)}`;
            }
            
            // æ›´æ–°ç©å®¶2å¡ç‰Œ
            if (gameState.player2 && gameState.player2.name) {
                document.getElementById('battlePlayer2Name').textContent = gameState.player2.name;
                document.getElementById('battlePlayer2Type').textContent = gameState.player2.type.toUpperCase();
                // é¡¯ç¤ºç•¶å‰æ”»æ“ŠåŠ›ï¼ˆåŒ…å«åŠ æˆï¼‰
                const currentAttack = gameState.player2.attack + (gameState.player2.tempAttackBoost || 0);
                document.getElementById('battlePlayer2Attack').textContent = currentAttack;
                // é¡¯ç¤ºç•¶å‰é˜²ç¦¦åŠ›ï¼ˆåŒ…å«åŠ æˆï¼‰
                const currentDefense = gameState.player2.defense + (gameState.player2.tempDefenseBoost || 0);
                document.getElementById('battlePlayer2Defense').textContent = currentDefense;
                document.getElementById('battlePlayer2Card').className = `battle-card wuxing-${getWuxingClass(gameState.player2.type)}`;
            }

            // æ›´æ–°ç”Ÿå‘½å€¼æ¢
            if (gameState.player1 && gameState.player2) {
                updateHpBar('player1');
                updateHpBar('player2');
            }

            // æ›´æ–°éª°å­æŒ‰éˆ•
            const diceBtn = document.getElementById('diceBtn');
            if (!diceBtn) return;
            
            if (gameState.battleEnded) {
                diceBtn.disabled = true;
                diceBtn.innerHTML = 'ğŸ æˆ°é¬¥çµæŸ';
            } else if (gameState.player1 && gameState.player1.name && gameState.player2 && gameState.player2.name) {
                diceBtn.disabled = false;
                diceBtn.innerHTML = `ğŸ² æ“²éª°å­ (ä¸‹å€‹å›åˆï¼š${gameState[gameState.currentTurn].name})`;
            } else {
                diceBtn.innerHTML = 'ğŸ² æ“²éª°å­ (ç­‰å¾…é–‹å§‹)';
            }
        }

        function getWuxingClass(type) {
            const classMap = {
                'é‡‘': 'jin',
                'æœ¨': 'mu', 
                'æ°´': 'shui',
                'ç«': 'huo',
                'åœŸ': 'tu'
            };
            return classMap[type] || 'jin';
        }

        function updateHpBar(player) {
            const monster = gameState[player];
            const hpPercentage = (monster.currentHp / monster.maxHp) * 100;
            
            document.getElementById(`battle${player.charAt(0).toUpperCase() + player.slice(1)}HpFill`).style.width = `${hpPercentage}%`;
            document.getElementById(`battle${player.charAt(0).toUpperCase() + player.slice(1)}HpText`).textContent = `${monster.currentHp}/${monster.maxHp}`;
        }

        // è§£ææŠ€èƒ½æ•ˆæœ
        function parseSkillEffect(skillDescription) {
            const effects = {
                damage: 0,
                heal: 0,
                defenseBoost: 0,
                attackBoost: 0,
                shield: false
            };
            
            // åŒ¹é…å‚·å®³æ•¸å€¼ (ä¾‹å¦‚ï¼šé€ æˆ45é»å‚·å®³ã€é€ æˆ55é»å‚·å®³)
            const damageMatch = skillDescription.match(/é€ æˆ(\d+)é»å‚·å®³/);
            if (damageMatch) {
                effects.damage = parseInt(damageMatch[1]);
            }
            
            // åŒ¹é…æ²»ç™‚æ•¸å€¼ (ä¾‹å¦‚ï¼šæ¢å¾©30é»ç”Ÿå‘½å€¼)
            const healMatch = skillDescription.match(/æ¢å¾©(\d+)é»ç”Ÿå‘½å€¼/);
            if (healMatch) {
                effects.heal = parseInt(healMatch[1]);
            }
            
            // åŒ¹é…é˜²ç¦¦åŠ›æå‡ (ä¾‹å¦‚ï¼šå¢åŠ è‡ªèº«10é»é˜²ç¦¦åŠ›)
            const defenseMatch = skillDescription.match(/å¢åŠ .*?(\d+)é»é˜²ç¦¦åŠ›/);
            if (defenseMatch) {
                effects.defenseBoost = parseInt(defenseMatch[1]);
            }
            
            // åŒ¹é…æ”»æ“ŠåŠ›æå‡ (ä¾‹å¦‚ï¼šå¢åŠ 15é»æ”»æ“ŠåŠ›)
            const attackMatch = skillDescription.match(/å¢åŠ .*?(\d+)é»æ”»æ“ŠåŠ›/);
            if (attackMatch) {
                effects.attackBoost = parseInt(attackMatch[1]);
            }
            
            // åŒ¹é…è­·ç›¾æ•ˆæœ (ä¾‹å¦‚ï¼šæ¸›å°‘ä¸‹æ¬¡å—åˆ°çš„å‚·å®³50%ã€é‡‘å±¬é˜²è­·)
            if (skillDescription.includes('æ¸›å°‘') && skillDescription.includes('å‚·å®³') || 
                skillDescription.includes('é˜²è­·') || skillDescription.includes('å®ˆè­·')) {
                effects.shield = true;
            }
            
            return effects;
        }

        // å…¨è‡ªå‹•æˆ°é¬¥ç³»çµ±
        function nextTurn() {
            if (gameState.battleEnded) return;
            
            try {
                const attacker = gameState[gameState.currentTurn];
                const defender = gameState[gameState.currentTurn === 'player1' ? 'player2' : 'player1'];
                
                // éš¨æ©Ÿé¸æ“‡è¡Œå‹•
                const actions = ['attack', 'skill1', 'skill2', 'defend'];
                const randomAction = actions[Math.floor(Math.random() * actions.length)];
                
                let damage = 0;
                let message = '';

                switch (randomAction) {
                    case 'attack':
                        damage = calculateDamage(attacker, defender, 'normal');
                        if (defender.isDefending) {
                            damage = Math.floor(damage * 0.7); // é˜²ç¦¦ç‹€æ…‹æ¸›å°‘30%å‚·å®³
                            message = `${attacker.name} ä½¿ç”¨æ™®é€šæ”»æ“Šï¼Œä½† ${defender.name} æ­£åœ¨é˜²ç¦¦ï¼Œå‚·å®³æ¸›å°‘30%ï¼Œå—åˆ° ${damage} é»å‚·å®³ï¼`;
                        } else if (defender.shieldActive) {
                            damage = Math.floor(damage / 2); // è­·ç›¾æ•ˆæœæ¸›åŠ
                            message = `${attacker.name} ä½¿ç”¨æ™®é€šæ”»æ“Šï¼Œä½† ${defender.name} æœ‰è­·ç›¾æ•ˆæœï¼Œå‚·å®³æ¸›åŠï¼Œå—åˆ° ${damage} é»å‚·å®³ï¼`;
                        } else {
                            message = `${attacker.name} ä½¿ç”¨æ™®é€šæ”»æ“Šï¼Œå° ${defender.name} é€ æˆ ${damage} é»å‚·å®³ï¼`;
                        }
                        defender.currentHp = Math.max(0, defender.currentHp - damage);
                        // æ¸…é™¤è­·ç›¾æ•ˆæœ
                        if (defender.shieldActive) defender.shieldActive = false;
                        addBattleLog(message, 'attack');
                        break;

                    case 'skill1':
                        executeSkill(attacker, defender, attacker.skill1, 'skill1');
                        break;

                    case 'skill2':
                        executeSkill(attacker, defender, attacker.skill2, 'skill2');
                        break;

                    case 'defend':
                        attacker.isDefending = true;
                        message = `${attacker.name} é€²å…¥é˜²ç¦¦ç‹€æ…‹ï¼Œä¸‹æ¬¡å—åˆ°çš„å‚·å®³æ¸›å°‘30%ï¼`;
                        addBattleLog(message, 'defend');
                        break;
                }

                // é‡ç½®å°æ–¹çš„é˜²ç¦¦ç‹€æ…‹ï¼ˆé™¤éç•¶å‰å›åˆé¸æ“‡é˜²ç¦¦ï¼‰
                if (randomAction !== 'defend') {
                    defender.isDefending = false;
                }

                // åˆ‡æ›å›åˆ
                gameState.currentTurn = gameState.currentTurn === 'player1' ? 'player2' : 'player1';

                updateBattleUI();

                // æª¢æŸ¥æˆ°é¬¥æ˜¯å¦çµæŸ
                if (defender.currentHp <= 0) {
                    endBattle(gameState.currentTurn === 'player1' ? 'player2' : 'player1');
                    return;
                }
            } catch (e) {
                console.error('æˆ°é¬¥éŒ¯èª¤:', e);
            }
        }

        // åŸ·è¡ŒæŠ€èƒ½æ•ˆæœ
        function executeSkill(attacker, defender, skillDescription, skillType) {
            const effects = parseSkillEffect(skillDescription);
            let messages = [];
            
            // é¡¯ç¤ºæŠ€èƒ½ä½¿ç”¨
            messages.push(`${attacker.name} ä½¿ç”¨æŠ€èƒ½ï¼š${skillDescription}`);
            
            // è™•ç†å›ºå®šå‚·å®³æ•ˆæœï¼ˆä¸ç¶“éè¤‡é›œè¨ˆç®—ï¼‰
            if (effects.damage > 0) {
                let damage = effects.damage;
                
                // ç°¡å–®çš„å±¬æ€§ç›¸å‰‹è¨ˆç®—
                const attackerRelations = wuxingRelations[attacker.type];
                if (attackerRelations && attackerRelations.resistance === defender.type) {
                    damage = Math.floor(damage * 1.2); // å…‹åˆ¶æ™‚å‚·å®³æå‡20%
                    messages.push('ğŸ’¥ æ•ˆæœæ‹”ç¾¤ï¼');
                } else if (attackerRelations && attackerRelations.weakness === defender.type) {
                    damage = Math.floor(damage * 0.8); // è¢«å…‹åˆ¶æ™‚å‚·å®³é™ä½20%
                    messages.push('ğŸ˜µ æ•ˆæœä¸ä½³...');
                }
                
                // é˜²ç¦¦ç‹€æ…‹æ¸›å‚·
                if (defender.isDefending) {
                    damage = Math.floor(damage / 2);
                    messages.push(`${defender.name} æ­£åœ¨é˜²ç¦¦ï¼Œå‚·å®³æ¸›åŠï¼`);
                }
                
                defender.currentHp = Math.max(0, defender.currentHp - damage);
                messages.push(`å° ${defender.name} é€ æˆ ${damage} é»å‚·å®³ï¼`);
            }
            
            // è™•ç†æ²»ç™‚æ•ˆæœ
            if (effects.heal > 0) {
                const healAmount = Math.min(effects.heal, attacker.maxHp - attacker.currentHp);
                attacker.currentHp += healAmount;
                messages.push(`${attacker.name} æ¢å¾©äº† ${healAmount} é»ç”Ÿå‘½å€¼ï¼`);
            }
            
            // è™•ç†é˜²ç¦¦åŠ›æå‡ï¼ˆæˆ°é¬¥ä¸­è‡¨æ™‚æå‡ï¼‰
            if (effects.defenseBoost > 0) {
                if (!attacker.tempDefenseBoost) attacker.tempDefenseBoost = 0;
                attacker.tempDefenseBoost += effects.defenseBoost;
                messages.push(`${attacker.name} çš„é˜²ç¦¦åŠ›å¢åŠ äº† ${effects.defenseBoost} é»ï¼`);
            }
            
            // è™•ç†æ”»æ“ŠåŠ›æå‡ï¼ˆæˆ°é¬¥ä¸­è‡¨æ™‚æå‡ï¼‰
            if (effects.attackBoost > 0) {
                if (!attacker.tempAttackBoost) attacker.tempAttackBoost = 0;
                attacker.tempAttackBoost += effects.attackBoost;
                messages.push(`${attacker.name} çš„æ”»æ“ŠåŠ›å¢åŠ äº† ${effects.attackBoost} é»ï¼`);
            }
            
            // è™•ç†è­·ç›¾æ•ˆæœï¼ˆä¸‹æ¬¡å—å‚·æ¸›åŠï¼‰
            if (effects.shield) {
                attacker.shieldActive = true;
                messages.push(`${attacker.name} ç²å¾—è­·ç›¾æ•ˆæœï¼Œä¸‹æ¬¡å—åˆ°çš„å‚·å®³æ¸›åŠï¼`);
            }
            
            // å¦‚æœæ²’æœ‰ç‰¹æ®Šæ•ˆæœï¼Œä½¿ç”¨é»˜èªæŠ€èƒ½å‚·å®³è¨ˆç®—
            if (effects.damage === 0 && effects.heal === 0 && effects.defenseBoost === 0 && 
                effects.attackBoost === 0 && !effects.shield) {
                let damage = calculateDamage(attacker, defender, 'skill');
                if (defender.isDefending || defender.shieldActive) {
                    damage = Math.floor(damage / 2);
                    messages.push(`${defender.name} æœ‰é˜²è­·æ•ˆæœï¼Œå‚·å®³æ¸›åŠï¼`);
                }
                defender.currentHp = Math.max(0, defender.currentHp - damage);
                messages.push(`å° ${defender.name} é€ æˆ ${damage} é»å‚·å®³ï¼`);
            }
            
            // æ¸…é™¤ä½¿ç”¨éçš„è­·ç›¾æ•ˆæœ
            if (defender.shieldActive) {
                defender.shieldActive = false;
            }
            
            // è¼¸å‡ºæ‰€æœ‰æˆ°é¬¥è¨Šæ¯
            messages.forEach(msg => addBattleLog(msg, 'skill'));
        }

        function calculateDamage(attacker, defender, attackType) {
            try {
                // è¨ˆç®—åŸºç¤æ”»æ“ŠåŠ›ï¼ˆåŒ…å«è‡¨æ™‚åŠ æˆï¼‰
                let baseDamage = attacker.attack + (attacker.tempAttackBoost || 0);
                
                // æŠ€èƒ½æ”»æ“Šå¨åŠ›æ›´å¤§
                if (attackType === 'skill') {
                    baseDamage = Math.floor(baseDamage * 1.5);
                }

                // å±¬æ€§ç›¸å‰‹è¨ˆç®—
                const attackerRelations = wuxingRelations[attacker.type];
                if (attackerRelations && attackerRelations.resistance === defender.type) {
                    baseDamage = Math.floor(baseDamage * 1.3);
                    addBattleLog('ğŸ’¥ æ•ˆæœæ‹”ç¾¤ï¼', 'system');
                } else if (attackerRelations && attackerRelations.weakness === defender.type) {
                    baseDamage = Math.floor(baseDamage * 0.7);
                    addBattleLog('ğŸ˜µ æ•ˆæœä¸ä½³...', 'system');
                }

                // é˜²ç¦¦åŠ›è¨ˆç®—ï¼ˆåŒ…å«è‡¨æ™‚åŠ æˆï¼‰
                const totalDefense = defender.defense + (defender.tempDefenseBoost || 0);
                const finalDamage = Math.max(1, baseDamage - Math.floor(totalDefense / 2));
                
                // éš¨æ©Ÿæ³¢å‹• (Â±15%)
                const variation = 0.85 + Math.random() * 0.3;
                
                return Math.max(1, Math.floor(finalDamage * variation));
            } catch (e) {
                console.error('å‚·å®³è¨ˆç®—éŒ¯èª¤:', e);
                return 1;
            }
        }

        function calculateDamage(attacker, defender, attackType) {
            try {
                let baseDamage = attacker.attack;
                
                // æŠ€èƒ½æ”»æ“Šå¨åŠ›æ›´å¤§
                if (attackType === 'skill') {
                    baseDamage = Math.floor(baseDamage * 1.8);
                }

                // å±¬æ€§ç›¸å‰‹è¨ˆç®—
                const attackerRelations = wuxingRelations[attacker.type];
                if (attackerRelations && attackerRelations.resistance === defender.type) {
                    baseDamage = Math.floor(baseDamage * 1.5);
                    addBattleLog('ğŸ’¥ æ•ˆæœæ‹”ç¾¤ï¼', 'system');
                } else if (attackerRelations && attackerRelations.weakness === defender.type) {
                    baseDamage = Math.floor(baseDamage * 0.7);
                    addBattleLog('ğŸ˜µ æ•ˆæœä¸ä½³...', 'system');
                }

                // é˜²ç¦¦åŠ›è¨ˆç®—
                const finalDamage = Math.max(1, baseDamage - defender.defense);
                
                // éš¨æ©Ÿæ³¢å‹• (Â±20%)
                const variation = 0.8 + Math.random() * 0.4;
                
                // å‚·å®³èª¿æ•´åˆ°åˆç†ç¯„åœ
                return Math.max(1, Math.floor(finalDamage * variation / 3));
            } catch (e) {
                console.error('å‚·å®³è¨ˆç®—éŒ¯èª¤:', e);
                return 1;
            }
        }

        function addBattleLog(message, type) {
            const log = document.getElementById('battleLog');
            if (!log) return;
            
            const entry = document.createElement('div');
            entry.className = `log-entry log-${type}`;
            entry.textContent = message;
            log.appendChild(entry);
            log.scrollTop = log.scrollHeight;
        }

        function endBattle(winner) {
            gameState.battleEnded = true;
            const gameOverDiv = document.getElementById('gameOver');
            const winnerText = document.getElementById('winnerText');
            const gameOverMessage = document.getElementById('gameOverMessage');

            const winnerData = gameState[winner];
            winnerText.textContent = 'ğŸ‰ å‹åˆ©ï¼';
            winnerText.style.color = '#10b981';
            gameOverMessage.textContent = `æ­å–œï¼${winnerData.name} è´å¾—äº†é€™å ´å²è©©èˆ¬çš„æˆ°é¬¥ï¼`;
            addBattleLog(`ğŸ† ${winnerData.name} ç²å¾—å‹åˆ©ï¼`, 'system');

            gameOverDiv.style.display = 'flex';
        }

        function restartBattle() {
            document.getElementById('gameOver').style.display = 'none';
            document.getElementById('battleLog').innerHTML = '';
            
            // é‡ç½®æˆ°é¬¥ç‹€æ…‹
            gameState.player1.currentHp = gameState.player1.maxHp;
            gameState.player2.currentHp = gameState.player2.maxHp;
            gameState.player1.isDefending = false;
            gameState.player2.isDefending = false;
            // é‡æ–°éš¨æ©Ÿæ±ºå®šå…ˆæ‰‹
            gameState.currentTurn = Math.random() < 0.5 ? 'player1' : 'player2';
            gameState.battleEnded = false;
            gameState.skillCooldown = 0;
            
            updateBattleUI();
            addBattleLog('ğŸ® æˆ°é¬¥é‡æ–°é–‹å§‹ï¼', 'system');
            addBattleLog(`${gameState.player1.name} VS ${gameState.player2.name}`, 'system');
            addBattleLog(`ğŸ¯ ${gameState[gameState.currentTurn].name} ç²å¾—å…ˆæ‰‹æ¬Šï¼`, 'system');
        }

        function backToCreation() {
            document.getElementById('gameOver').style.display = 'none';
            document.getElementById('battlePage').style.display = 'none';
            document.getElementById('cardCreationPage').style.display = 'block';
            document.getElementById('battleLog').innerHTML = '';
            
            // é‡ç½®éŠæˆ²ç‹€æ…‹
            gameState = {
                player1: {},
                player2: {},
                currentTurn: 'player1',
                battleEnded: false,
                skillCooldown: 0,
                player1Image: null,
                player2Image: null
            };
            
            // é‡ç½®éª°å­æŒ‰éˆ•
            const diceBtn = document.getElementById('diceBtn');
            if (diceBtn) {
                diceBtn.innerHTML = 'ğŸ² æ“²éª°å­ (ç­‰å¾…é–‹å§‹)';
            }
        }

        // ä¸‹è¼‰å¡ç‰ŒåŠŸèƒ½
        function downloadCard(player) {
            const cardElement = document.getElementById(`${player}Card`);
            
            // ä½¿ç”¨html2canvasä¾†æˆªåœ–å¡ç‰Œ
            html2canvas(cardElement, {
                scale: 2,
                backgroundColor: null,
                useCORS: true
            }).then(canvas => {
                // å‰µå»ºä¸‹è¼‰éˆæ¥
                const link = document.createElement('a');
                const monsterName = document.getElementById(`${player}NameInput`).value;
                link.download = `${monsterName}_äº”è¡Œå¡ç‰Œ.png`;
                link.href = canvas.toDataURL('image/png');
                link.click();
            }).catch(error => {
                console.error('æˆªåœ–å¤±æ•—:', error);
                alert('ä¸‹è¼‰å¤±æ•—ï¼Œè«‹ç¨å¾Œå†è©¦ã€‚');
            });
        }

        // åˆå§‹åŒ–
        document.addEventListener('DOMContentLoaded', function() {
            try {
                setupRealTimeUpdates();
                updateCardColors('player1');
                updateCardColors('player2');
                updateTypeDefaults('player1', 'åœŸ');
                updateTypeDefaults('player2', 'é‡‘');
                updateHPAttackConstraint('player1');
                updateHPAttackConstraint('player2');
                
                // ç¢ºä¿éª°å­æŒ‰éˆ•åˆå§‹ç‹€æ…‹æ­£ç¢º
                const diceBtn = document.getElementById('diceBtn');
                if (diceBtn) {
                    diceBtn.innerHTML = 'ğŸ² æ“²éª°å­ (ç­‰å¾…é–‹å§‹)';
                }
            } catch (e) {
                console.error('åˆå§‹åŒ–éŒ¯èª¤:', e);
            }
        });
    </script>
</body>
</html>